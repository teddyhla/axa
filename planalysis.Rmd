---
title: "Preliminary Analysis"
author: "teddyhla"
date: "25/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Source of Data

This document details the data cleaning and preliminary analysis of anti Xa measurements on VV ecmo patients. 

Three cohorts of VV ecmo patients are identified :- 
- wave 1 of covid - 19, defined as between 01-03-2020 to 31-08-2020 inclusive.
- wave 2 of covid - 19, defined as between 01-09-2020 to 01-03-2021 inclusive.
- historical flu, defined as 01-01-2015 and 31-12-2019 inclusive. 

## Questions
- what about non covid and non flu patients in this period? isnt it better to capture 01-01-2015 to 01-01-2022 ? 
- Ans : better to focus on viral aetiology. 
- what about large gaps - is it true?
- Ans : as per above 
- what about lmwh / flolan / argotraban ? 
- Ans : only heparin was used 
- mrn 6960892X as admission date = as discharge date ? typo
- 6842347C has wrong time to cannulation, 
the rest may be one day off ? - 6578155C,6578347K,1087895N,6939825N have issues.

- for looking at labs data,6381359H (missing data 3 days on blood),6855512Y(missing data 2/3 days pre),6855430Y,6922730D,6971769E
- for looking at labs data duration , 
- ecmo run time as gold standard? 
- Ans : agreed 

## Sensecheck 
- no repeat admissions?
- Ans : true
- peak 3 ecmo admission in 24 hour ?
- Ans : true

## Patient identification
- ecmo blood pump speed was calculated from min to max dates and substracted to get ecmo run times and patients

## Heparin administration
Heparin was administered in 4 different formats 
- heparin units/hr
- heparin ecmo xa iv infusion units/kg/hr
- heparin iv injection units
- heprin rrt inf 2000 iu units
- heparin systemic inf 2000 units units/hr
- Ans : agree this is the complexity of heparin prescription in ecmo.
Intravenous unfractionated heparin infusion (UFH) was used with 50 IU/kg as a bolus at the
time of cannulation with 2,500 units in the priming fluid for the circuit unless contraindicated
due to bleeding.
Prior to 1st November 2019, UFH infusions were monitored by activated partial thromboplastin
time ratio (APTTr) with a target level of 1.5-2.0 if evidence of no thrombosis and haemorrhage
and 2.0-2.5 if a thrombotic event.
From 1st November 2019 to present, anti-Xa activity was used for monitoring targeting levels
of 0.3 - 0.7 unit/mL if no evidence of thrombosis or haemorrhage were present and 0.6 - 1.0
unit/mL if there was a thrombotic ev

weight is also extracted to calculate units/hr/hr 

## Coagulation lab results
- anti Xa and APTTR results were extracted

## Bleeding scores are extracted from ICIP. 

# Load dependencies

```{r}
library(ggplot2)
library(cowplot)
library(survminer)
library(survival)
library(plotly)
```

# Source the cleaned files
```{r}
source("datatidy.R")
```

# Cleaning Pt 

```{r}
head(pt)
summary(pt)
```

```{r}
ggplot(data = pt, aes(x=admissiondate,color = cohort))+
               geom_bar(binwidth = 86400)
```

```{r}
pt %>% 
        count(mrn) %>%
        filter(n>1)
```

crude mortality rate per waves
```{r}
pt %>% 
        select(cohort,survivedecmo) %>% 
        group_by(cohort) %>% 
        summarise(totalno = n(),
        deathsonecmo = sum(survivedecmo == "no"),
        cmr = deathsonecmo/totalno)
        
```


```{r}
pt %>% 
        mutate (ecmorunt= dateDEcannulated - datecannulated) %>%
        group_by(cohort) %>%
        summarise (
                count = n(),
                mean = mean(ecmorunt),
                mode = max(ecmorunt),
                min = min(ecmorunt),
                median=median(ecmorunt))
```

```{r}
labdur <- full_join(
        labdur,
        pt %>% select(mrn,cohort), 
        by = "mrn")
```

```{r}
labdur %>% 
        group_by(cohort) %>%
        summarise (
                meand = mean (labd),
                mode = max(labd),
                min = min (labd),
                median = median(labd))
```

```{r}
summary(as.numeric(tdiff))
```


two different type of missing data.
recorded as NA
and not in the sheets at all.
- i believe should use a clean admin duration vs. ecmo run duration.

5 number summary per waves

as seen above there is wildly different ranges. 

 [1] "5766199G" "5933615A" "2553305Z" "5981704A" "6019233K" "6388792B" "2746912G"
 [8] "6396244K" "6578155C" "6776201S" "6851184E" "5277619S" "6852899A" "6855137S"
[15] "6860416Y" "6908775W"

above is missing from hep df.

so units need deciding ? units vs. units/hr vs units/kg/hr
so kg needs deciding as "NA" vs "TRUE

how are the rprescriotns changed ? e.g., is it hourly built up ? 

may be that it is not NA but if you generate a time stamp for each time blood is monitored, then those with less frequent will have more NAs?


for example >there are values attached to it.

lab[lab$dtm < as.Date("2015-01-01"),]
# A tibble: 4 Ã— 4
  mrn      dtm                   axa apttr
  <chr>    <dttm>              <dbl> <dbl>
1 4169075Q 2012-12-24 00:00:00    NA NA   
2 4169075Q 2012-12-24 02:21:00    NA  1   
3 5299955S 2012-06-11 09:41:00    NA  1   
4 1419834R 2006-04-28 17:54:00    NA  1.07

playing around

```{r}

gh <- clab
gh$day_on_e <- as.factor(gh$day_on_e)
ylim1 <- boxplot.stats(clab$axa)$stats[c(1,5)]
ylim2 <- boxplot.stats(clab$apttr)$stats[c(1,5)]

p1 <- ggplot(data = gh, aes(x=day_on_e,y = axa)) + 
        geom_boxplot(outlier.shape = NA)+
        geom_hline(yintercept = 0.3)+
        geom_hline(yintercept = 0.7)+
        coord_cartesian(ylim = ylim1*1.05)+
        ggtitle("axa")+
        facet_wrap(~cohort)
      

p2 <- ggplot(data = gh, aes(x=day_on_e,y=apttr))+
      geom_boxplot(outlier.shape = NA)+
      geom_hline(yintercept = 1.5) +
      geom_hline(yintercept = 2.0)+
      coord_cartesian(ylim = ylim2*1.05)+
      ggtitle("apttr")+
      facet_wrap(~cohort)

p3 <- plot_grid(p1,p2)

```

```{r}
ggplotly(p1)
```

# Survival 
```{r }
pts <- pt %>%
        select(ecmorunt,cohort,survivedecmo)
summary(pts)

```

```{r}
ps <- survfit (Surv(ecmorunt,survivedecmo == "no")~cohort, data = pts)
ggsurvplot(ps,pval = TRUE,risk.table = TRUE, risk.table.col = "cohort",risk.table.height = 0.3,surv.median.line = "hv")

```

ambition
